<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../common/style.css">
  <link rel="stylesheet" href="../styles/cronomtro_y.css">
  <title>Cronómetro Y</title>
</head>
<body>
    <a href="index.html">
        <img class="cronoMouse" src="../img/CronoMouse text.png" width="30%">
    </a>
  <h1>Cronómetro Laberinto Y</h1>

  <!-- Caja de texto para nombre del ratón -->
  <input type="text" id="nombreRaton" placeholder="Nombre del ratón" style="margin-bottom: 20px; padding: 10px; font-size: 16px; width: 280px;">

    <div class="fila-zona">
      <span id="contadorEntradasA" class="contador">0</span>
      <button class="zona a" onclick="cambiarZona('A')">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/stopwatch.png" alt="cronómetro"> 
        Zona A
        <span class="tiempo" id="tA">0:00.0</span>
      </button>
      <button class="velocidad" onclick="cambiarVelocidad()">X2</button>
      <span id="contadorRepeticionesA" class="contador repeticion">0</span> <!-- nuevo -->
    </div>

    <div class="fila-zona">
      <span id="contadorEntradasB" class="contador">0</span>
      <button class="zona b" onclick="cambiarZona('B')">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/stopwatch.png" alt="cronómetro"> 
        Zona B
        <span class="tiempo" id="tB">0:00.0</span>
      </button>    
      <button class="velocidad" onclick="cambiarVelocidad()">X2</button>    
      <span id="contadorRepeticionesB" class="contador repeticion">0</span> <!-- nuevo -->
    </div>

    <div class="fila-zona">
      <span id="contadorEntradasC" class="contador">0</span>
      <button class="zona c" onclick="cambiarZona('C')">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/stopwatch.png" alt="cronómetro"> 
        Zona C
        <span class="tiempo" id="tC">0:00.0</span>
      </button>    
      <button class="velocidad" onclick="cambiarVelocidad()">X2</button>    
      <span id="contadorRepeticionesC" class="contador repeticion">0</span> <!-- nuevo -->
    </div>


    <div class="fila-zona">
    <span id="contadorEntradasCentro" class="contador">0</span>
    <button class="zona centro" onclick="cambiarZona('D')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/stopwatch.png" alt="cronómetro"> 
      Centro
      <span class="tiempo" id="tD">0:00.0</span>
    </button>    
      <button class="velocidad" onclick="cambiarVelocidad()">
        X2
      </button>    
  </div>

  <div class="acciones">
      <button class="accion" style="background-color: rgb(217, 3, 3);" onclick="detener()">Detener</button>
      <button class="accion" style="background:#00ca03;" onclick="guardar()">Guardar</button>
      <button class="accion" style="background:#9C27B0;" onclick="restablecer()">Restablecer</button>
  </div>
  

  <button class="atras" onclick="location.href='index.html'">Atrás</button>

  <div id="guardados" style="margin-top:20px; text-align:left; font-size:16px;"></div>

  <script>
    let tiempos = { A: 0, B: 0, C: 0, D: 0 };
    let inicio = null;
    let zonaActiva = null;
    let ultimoZona = null;
    let intervalo = null;
    let contadorGuardados = 1;
    let registros = [];

    let contadorEntradasA = 0;
    let contadorEntradasB = 0;
    let contadorEntradasC = 0;
    let contadorEntradasCentro = 0;

    let repeticionesA = 0;
    let repeticionesB = 0;
    let repeticionesC = 0;
    let zonaAntesCentro = null;


    // Factor de velocidad (1 = normal, 2 = doble)
    let factorVelocidad = 1;

    function cambiarZona(nuevaZona) {
      const ahora = Date.now();

      if (zonaActiva !== null) {
        tiempos[zonaActiva] += (ahora - inicio) * factorVelocidad;
      }

      const prevZona = (zonaActiva !== null) ? zonaActiva : ultimoZona;

      // --- NUEVO BLOQUE: detectar repeticiones ---
      if (prevZona === "D" && nuevaZona !== "D" && zonaAntesCentro === nuevaZona) {
        // volvió al mismo brazo después del centro
        if (nuevaZona === "A") {
          repeticionesA++;
          document.getElementById("contadorRepeticionesA").innerText = repeticionesA;
        }
        if (nuevaZona === "B") {
          repeticionesB++;
          document.getElementById("contadorRepeticionesB").innerText = repeticionesB;
        }
        if (nuevaZona === "C") {
          repeticionesC++;
          document.getElementById("contadorRepeticionesC").innerText = repeticionesC;
        }
      }
      // --- FIN BLOQUE NUEVO ---

      // --- actualizar zona antes del centro ---
      if (prevZona !== "D" && nuevaZona === "D") {
        zonaAntesCentro = prevZona; // guarda el brazo antes de entrar al centro
      }

      // --- incrementos normales de entradas ---
      if (nuevaZona === "A" && prevZona !== "A") {
        contadorEntradasA++;
        document.getElementById("contadorEntradasA").innerText = contadorEntradasA;
      }
      if (nuevaZona === "B" && prevZona !== "B") {
        contadorEntradasB++;
        document.getElementById("contadorEntradasB").innerText = contadorEntradasB;
      }
      if (nuevaZona === "C" && prevZona !== "C") {
        contadorEntradasC++;
        document.getElementById("contadorEntradasC").innerText = contadorEntradasC;
      }
      if (nuevaZona === "D" && prevZona !== "D") {
        contadorEntradasCentro++;
        document.getElementById("contadorEntradasCentro").innerText = contadorEntradasCentro;
      }

      zonaActiva = nuevaZona;
      inicio = ahora;
      ultimoZona = nuevaZona;

      if (!intervalo) {
        intervalo = setInterval(actualizarPantalla, 100);
      }
    }


    function detener() {
      const ahora = Date.now();
      if (zonaActiva !== null) {
        tiempos[zonaActiva] += (ahora - inicio) * factorVelocidad;

        ultimoZona = zonaActiva;
      }
      clearInterval(intervalo);
      intervalo = null;
      zonaActiva = null;
    }

    function guardar() {
      detener(); // aseguro que no siga corriendo

      let nombre = document.getElementById("nombreRaton").value.trim();
      if (!nombre) {
        nombre = `Guardado por defecto de ratón ${contadorGuardados}`;
      }
      contadorGuardados++;

      // buscar si ya existe el registro
      let existente = registros.find(r => r.nombre === nombre);

      if (existente) {
        // sumamos los tiempos
        existente.A += tiempos.A;
        existente.B += tiempos.B;
        existente.C += tiempos.C;
        existente.D += tiempos.D;
      } else {
        // creamos uno nuevo
        let registro = {
          nombre: nombre,
          A: tiempos.A,
          B: tiempos.B,
          C: tiempos.C,
          D: tiempos.D
        };
        registros.push(registro);
      }

      mostrarGuardados();
    }

    function mostrarGuardados() {
      const div = document.getElementById("guardados");
      div.innerHTML = "<h3>Guardados:</h3>";
      registros.forEach((r, index) => {
        div.innerHTML += `
          <div style="margin-bottom:10px;">
            <strong>${r.nombre}</strong><br>
            A: ${formatearTiempo(r.A)} | 
            B: ${formatearTiempo(r.B)} | 
            C: ${formatearTiempo(r.C)}
            Centro: ${formatearTiempo(r.D)}
            <button onclick="eliminar(${index})" style="margin-left:10px; background:#d32f2f; color:white; border:none; padding:3px 6px; border-radius:4px; cursor:pointer;">Eliminar</button>
          </div>
        `;
      });
    }

    function eliminar(index) {
      registros.splice(index, 1);
      mostrarGuardados();
    }

    function restablecer() {
      detener();
      tiempos = { A: 0, B: 0, C: 0, D: 0 };
      document.getElementById("tA").innerText = "0:00.0";
      document.getElementById("tB").innerText = "0:00.0";
      document.getElementById("tC").innerText = "0:00.0";
      document.getElementById("tD").innerText = "0:00.0";

      contadorEntradasA = 0;
      document.getElementById("contadorEntradasA").innerText = "0";

      contadorEntradasB = 0;
      document.getElementById("contadorEntradasB").innerText = "0";

      contadorEntradasC = 0;
      document.getElementById("contadorEntradasC").innerText = "0";

      contadorEntradasCentro = 0;
      document.getElementById("contadorEntradasCentro").innerText = "0";

      ultimoZona = null;

      repeticionesA = 0;
      repeticionesB = 0;
      repeticionesC = 0;
      document.getElementById("contadorRepeticionesA").innerText = "0";
      document.getElementById("contadorRepeticionesB").innerText = "0";
      document.getElementById("contadorRepeticionesC").innerText = "0";
      zonaAntesCentro = null;

      // opcional: restaurar velocidad a 1 al restablecer
      factorVelocidad = 1;
      document.querySelectorAll(".velocidad").forEach(btn => btn.innerText = "X2");
    }

    function actualizarPantalla() {
      const ahora = Date.now();
      let temp = { ...tiempos };

      if (zonaActiva !== null) {
        temp[zonaActiva] += (ahora - inicio) * factorVelocidad;
      }

      document.getElementById("tA").innerText = formatearTiempo(temp.A);
      document.getElementById("tB").innerText = formatearTiempo(temp.B);
      document.getElementById("tC").innerText = formatearTiempo(temp.C);
      document.getElementById("tD").innerText = formatearTiempo(temp.D);
    }

    function formatearTiempo(ms) {
      let totalDecimas = Math.floor(ms / 100);
      let decimas = totalDecimas % 10;
      let totalSegundos = Math.floor(totalDecimas / 10);
      let segundos = totalSegundos % 60;
      let minutos = Math.floor(totalSegundos / 60);

      return `${minutos}:${segundos.toString().padStart(2, '0')}.${decimas}`;
    }

    function cambiarVelocidad() {
      const ahora = Date.now();

      // si hay zona activa, primero acumulamos lo ya transcurrido con el factor actual
      if (zonaActiva !== null) {
        tiempos[zonaActiva] += (ahora - inicio) * factorVelocidad;
        // reiniciamos el inicio a 'ahora' para la nueva velocidad
        inicio = ahora;
      }

      // alternamos factor
      factorVelocidad = (factorVelocidad === 1) ? 2 : 1;

      // actualizamos textos de botones
      document.querySelectorAll(".velocidad").forEach(btn => {
        btn.innerText = (factorVelocidad === 1) ? "X2" : "X1";
      });

      // refrescamos la pantalla para que el cambio se vea inmediatamente
      actualizarPantalla();
    }

  </script>

</body>
</html>
